# TechViral - Configuration Apache optimisée pour Hostinger
# Performance, sécurité et SEO - Optimisation 2025

# =============================================================================
# Réécritures d'URL et redirection
# =============================================================================

RewriteEngine On

# Forcer HTTPS (recommandé pour Hostinger)
RewriteCond %{HTTPS} !=on
RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# Rediriger vers www (ou sans www selon préférence)
RewriteCond %{HTTP_HOST} ^techviral\.com [NC]
RewriteRule ^(.*)$ https://www.techviral.com/$1 [L,R=301]

# CORRECTION: Réécriture interne pour que racine affiche index.html (preserve CSS)
RewriteCond %{REQUEST_URI} ^/$
RewriteRule ^$ index.html [L]

# URLs propres pour les catégories
RewriteRule ^categories/([a-zA-Z0-9-]+)/?$ pages/categories/$1.html [L,QSA]
RewriteRule ^promo/?$ pages/promotions.html [L,QSA]
RewriteRule ^contact/?$ pages/contact.html [L,QSA]

# Page d'erreur personnalisée
ErrorDocument 404 /pages/404.html
ErrorDocument 500 /pages/500.html

# =============================================================================
# Optimisation des performances
# =============================================================================

# Compression GZIP
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE text/javascript
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/json
    AddOutputFilterByType DEFLATE image/svg+xml
    AddOutputFilterByType DEFLATE font/truetype
    AddOutputFilterByType DEFLATE font/opentype
    AddOutputFilterByType DEFLATE application/vnd.ms-fontobject
</IfModule>

# Cache des ressources statiques
<IfModule mod_expires.c>
    ExpiresActive On
    
    # Images
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType image/x-icon "access plus 1 year"
    
    # Polices
    ExpiresByType font/woff "access plus 1 year"
    ExpiresByType font/woff2 "access plus 1 year"
    ExpiresByType font/ttf "access plus 1 year"
    ExpiresByType font/otf "access plus 1 year"
    ExpiresByType application/font-woff "access plus 1 year"
    ExpiresByType application/font-woff2 "access plus 1 year"
    
    # CSS et JavaScript
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType text/javascript "access plus 1 month"
    
    # HTML
    ExpiresByType text/html "access plus 1 day"
    
    # Manifeste et données
    ExpiresByType application/json "access plus 1 week"
    ExpiresByType application/manifest+json "access plus 1 week"
    ExpiresByType text/xml "access plus 1 week"
</IfModule>

# En-têtes de cache
<IfModule mod_headers.c>
    # Cache des ressources statiques
    <FilesMatch "\.(css|js|png|jpg|jpeg|gif|webp|svg|woff|woff2|ttf|otf)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
    </FilesMatch>
    
    # Cache pour HTML
    <FilesMatch "\.(html|htm)$">
        Header set Cache-Control "public, max-age=86400"
    </FilesMatch>
    
    # Sécurité
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    
    # CSP (Content Security Policy)
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com https://www.googletagmanager.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.tailwindcss.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self' https:"
    
    # Permissions Policy
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
</IfModule>

# =============================================================================
# Sécurité
# =============================================================================

# Masquer la version du serveur
ServerTokens Prod

# Interdire l'accès aux fichiers sensibles
<FilesMatch "\.(htaccess|htpasswd|ini|log|sh|sql|conf|bak|old)$">
    Order Allow,Deny
    Deny from all
</FilesMatch>

# Interdire l'accès aux dossiers système
RedirectMatch 404 /\.git
RedirectMatch 404 /config/
RedirectMatch 404 /docs/private/

# Protection contre les injections
<IfModule mod_rewrite.c>
    RewriteCond %{QUERY_STRING} (<|%3C).*script.*(>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} GLOBALS(=|\[|\%[0-9A-Z]{0,2}) [OR]
    RewriteCond %{QUERY_STRING} _REQUEST(=|\[|\%[0-9A-Z]{0,2}) [OR]
    RewriteCond %{QUERY_STRING} (<|%3C).*iframe.*(>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} (<|%3C).*object.*(>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} (<|%3C).*embed.*(>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} base64_encode.*\(.*\) [NC,OR]
    RewriteCond %{QUERY_STRING} (\.|%2E)(\.|%2E)(%2F|/) [NC]
    RewriteRule .* - [F,L]
</IfModule>

# =============================================================================
# Optimisation mobile et PWA
# =============================================================================

# MIME types pour PWA
AddType application/manifest+json .webmanifest .json

# Support WebP
<IfModule mod_rewrite.c>
    RewriteCond %{HTTP_ACCEPT} image/webp
    RewriteCond %{DOCUMENT_ROOT}/$1.webp -f
    RewriteRule ^(.*)\.(jpe?g|png)$ $1.webp [T=image/webp,E=accept:1]
</IfModule>

<IfModule mod_headers.c>
    Header append Vary Accept env=REDIRECT_accept
</IfModule>

# =============================================================================
# SEO et robots
# =============================================================================

# Redirection des pages supprimées vers la page d'accueil
# (À personnaliser selon les besoins)
# RedirectPermanent /old-page.html /

# Pagination SEO friendly
RewriteRule ^page/([0-9]+)/?$ /?page=$1 [L,QSA]

# =============================================================================
# Configuration Hostinger spécifique
# =============================================================================

# Optimisation pour l'hébergement mutualisé
<IfModule mod_php.c>
    php_value memory_limit 256M
    php_value max_execution_time 30
    php_value upload_max_filesize 10M
    php_value post_max_size 10M
</IfModule>

# Gestion des erreurs personnalisées
Options -Indexes
Options +FollowSymLinks

# =============================================================================
# Monitoring et analytics
# =============================================================================

# Logs personnalisés pour l'analyse
# LogFormat "%h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\"" combined
# CustomLog logs/access.log combined

# =============================================================================
# Compatibilité navigateurs
# =============================================================================

# Support des anciens navigateurs pour les polices
<IfModule mod_headers.c>
    <FilesMatch "\.(ttf|ttc|otf|eot|woff|woff2|font.css)$">
        Header set Access-Control-Allow-Origin "*"
    </FilesMatch>
</IfModule>

# Correction du MIME type pour les polices
AddType application/vnd.ms-fontobject .eot
AddType font/truetype .ttf
AddType font/opentype .otf
AddType application/font-woff .woff
AddType application/font-woff2 .woff2